---
title: "HW5"
author: "jgn2108"
date: "`r Sys.Date()`"
output: github_document
---

#Problem 1: Washington Post data in a github repository
```{r}
#install.packages("readr")
#install.packages("skimr")
#library(readr)
#library(tidyverse)
#library(skimr)
#library(dplyr)
#library(broom)
#library(purrr)
#library(broom)
#library(ggplot2)
```

#Read in data
```{r}
url <- "https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv"

# Read the CSV file into a data frame
homicide_data <- read_csv(url)

# View the first few rows of the data
head(homicide_data)
```
#Data cleaning (using skimr)
```{r}
# Use the skim() function directly from skimr without loading the whole package
skim_summary <- skimr::skim(homicide_data)

# Print the summary
print(skim_summary)

```
#Convert tibble into a standard df
```{r}
homicide_data_df <- as.data.frame(homicide_data)
str(homicide_data_df)
```
This data represents the names and demographics of homicide victims across the U.S., as well as the date the homicide was reported, the location (latitude/longitude) the victims were found, and the disposition of the case (i.e., whether an arrest was made or not).

#Reformat reported_date
```{r}
# Convert numeric date to Date object
homicide_data_df$reported_date <- as.Date(as.character(homicide_data_df$reported_date), format = "%Y%m%d")

# Format the date as MM/DD/YYYY
homicide_data_df$reported_date <- format(homicide_data_df$reported_date, "%m/%d/%Y")

```

#Create a new variable: city_state
```{r}
# Create city_state variable
homicide_data_df <- mutate(homicide_data_df, city_state = paste(city, state, sep = ", "))

# Summarize data
summary_data <- homicide_data_df %>%
  group_by(city_state) %>%
  summarize(
    total_homicides = n(),
    unsolved_homicides = sum(disposition %in% c("Closed without arrest", "Open/No arrest"))
  )

# Print the summary data
print(summary_data)
```
This new variable allows me to clearly see the total homicides vs. unsolved homicides by city/state.

#Now use the prop.test and broom::tidy functions for the subset of data related to Baltimore, MD
```{r}
# Subset data for Baltimore, MD
baltimore_data <- filter(homicide_data_df, city == "Baltimore" & state == "MD")

# Use prop.test to estimate the proportion of unsolved homicides
prop_test_result <- prop.test(
  sum(baltimore_data$disposition %in% c("Closed without arrest", "Open/No arrest")),
  nrow(baltimore_data)
)

# Now, apply broom::tidy to the prop.test result and print tidy results
tidy_result <- tidy(prop_test_result)
print(tidy_result)

# Extract estimated proportion and CIs
estimated_proportion <- tidy_result$estimate[1] #but i'm having trouble getting CIs

# Check if conf.int is available 
if (!is.null(tidy_result$conf.int)) {
  conf_int <- tidy_result$conf.int
  cat("Confidence Intervals:", conf_int[1], "to", conf_int[2], "\n")
} else {
  cat("Confidence Intervals: Not available\n")
}

# Print the estimated proportion
cat("Estimated Proportion of Unsolved Homicides:", estimated_proportion, "\n")

```
Estimated Proportion of Unsolved Homicides: 0.6455607 
Confidence Intervals: Not available

#trouble shooting why I can't get a CI
```{r}
#Make Balitimore data into a normal df and then see if there is missing data
baltimore_data_df <- as.data.frame(baltimore_data)
missing_rows <- complete.cases(baltimore_data_df)

# Subset the data to show only rows with missing observations
rows_with_missing <- baltimore_data_df[!missing_rows, ]

# Display rows with missing observations
print(rows_with_missing) #No missing data
```

#still trouble shooting why I can't get CIs
```{r}
#look into structure of tidy results
str(tidy_result) #AHHHH, the CIs are conf_int_low and conf_int_high

# Extract CIs and print
conf_int_low <- tidy_result$conf.low
conf_int_high <- tidy_result$conf.high
cat("Confidence Intervals:", conf_int_low, "to", conf_int_high, "\n")

```
Confidence Intervals: 0.6275625 to 0.6631599

#Now, I have to begin interating my commands using the prop.test function
```{r}
# Create a tidy pipeline
all_cities_results <- homicide_data_df %>%
  group_by(city) %>%
  nest() %>%
  mutate(
    prop_test_result = map(data, ~ {
      unsolved_homicides <- sum(.x$disposition %in% c("Closed without arrest", "Open/No arrest"))
      total_homicides <- nrow(.x)
      
      if (unsolved_homicides == 0) {
        # Handle cases where the number of unsolved homicides is zero
        return(tibble(estimate = 0, conf.low = 0, conf.high = 0))
      }
      
      prop.test(unsolved_homicides, total_homicides)
    }),
    tidy_result = map(prop_test_result, tidy)
  ) %>%
  unnest(tidy_result) %>%
  select(city, estimate, conf.low, conf.high)

# Print the proportions of unsolved murders and CIs for all cities 
print(all_cities_results)

```

#Now I have to use ggplot2 and geom_errorbar to create a plot that shows the estimated proportions and CIs for each city
```{r}

```


